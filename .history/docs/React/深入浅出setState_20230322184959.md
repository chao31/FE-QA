在认识 setState 前，我们问几个常见问题
- `setState` 是同步还是异步？
- 如果是`异步`，怎么让它`同步`？
- 为什么要这样设计？

## 基本概念和使用

官网介绍：


## setState 的特性——批处理

如果在同一周期多次调用 `setState` ，后调用的 `setState` 将覆盖先调用的 `setState` 的值，例如：

```js
// state.count === 0
this.setState({count: state.count + 1});
this.setState({count: state.count + 1});
this.setState({count: state.count + 1});
// state.count === 1
```
执行 `3` 次 `+1`，但最后只加了 `1` 次；若在 `setTimeout` 中多次调用，结果也一样
```js
// state.count === 0
setTimeout(() => {
    this.setState({count: state.count + 1});
    this.setState({count: state.count + 1});
    this.setState({count: state.count + 1});
}, 0)
// state.count === 1
```
因为这样的操作相当于 `Object.assign`,最后一个会把前面的都给覆盖
```js
// 相当于
Object.assign(
  state,
  {count: state.count + 1},
  {count: state.count + 1},
  {count: state.count + 1},
)
```
### 同一个时期，多次调用，会合并

```js
const DemoState = (props) => {
  let [number, setNumber] = useState(0);

  const add = () => {
    setNumber(number+1);
    console.log(number); // 0

    setNumber(number+1);
    console.log(number); // 0

    setNumber(number+1);
    console.log(number); // 0
  }

  return (
    <div>
        <span>{ number }</span>
        <button onClick={() => { add() }} >点击加 1</button>
    </div>
  )
}

// 0
// 0
// 0

// 页面展示 number 为 1
```

### 函数组件在不同时期，不会合并

`函数组件`多次调用 `+1` 操作，分别在不用时期：一个在 setTimeout `外`调用，另一个在 setTimeout `内`调用。最后`合并`了，`只调用了 1 次 +1`。

```js
const DemoState = (props) => {
  let [number, setNumber] = useState(0);

  const add = () => {
    setNumber(number+1);
    console.log(number); // 0

    setTimeout(() => {
      setNumber(number+1);
      console.log(number); // 0
      }, 0)
  }
  return (<div>
      <span>{ number }</span>
      <button onClick={() => { add() }} >点击加 1</button>
  </div>)
}

// 0
// 0 

// 页面展示 number 为 1
```

### 类组件在不同时期，会合并

`类组件`多次调用 `+1` 操作，分别在不用时期：一个在 setTimeout `外`调用，另一个在 setTimeout `内`调用。最后`没合并`，`2 次 +1 都被调用`。

```js
class DemoState2 extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      number: 0
    }
  }

  add = () => {
    this.setState({number: this.state.number + 1});
    console.log(this.state.number); // 0

    setTimeout(() => {
      this.setState({number: this.state.number + 1});
      console.log(this.state.number); // 1
    }, 0)
  }

  render() {
    return (
      <div>
        <span>{ this.state.number }</span>
        <button onClick={this.add} >点击加 1</button>
      </div>
    )
  }
}

// 0
// 1 

// 页面展示 number 为 2
```

当前测试 `react` 版本：`18.1.0`


