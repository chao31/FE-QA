# å®ç° createElement æ–¹æ³•

# æ¦‚è¦

- æœ¬æ–‡æ˜¯ä½œè€…åœ¨è¯»æ‡‚äº†å¤§ç¥`Rodrigo Pombo` çš„[ã€ŠBuild your own Reactã€‹](https://pomb.us/build-your-own-react/)æºç åï¼ŒåŠ ä¸Šäº†è‡ªå·±çš„ç†è§£ï¼Œä»¥åŠåšäº†å°‘é‡ä¿®æ”¹åçš„å®ç°ï¼Œåœ¨è¿™é‡Œå†æ¬¡æ„Ÿè°¢å¤§ç¥ï¼ğŸ™ğŸ»
- æ ¸å¿ƒä»£ç  200+ ğŸ‰
- fiber æ¶æ„çš„ react ğŸ”¥
- é€šä¿—æ˜“æ‡‚ï¼Œå¯¹æ ‡å…¨ç½‘æœ€ç®€å•çš„ react å®ç° ğŸ˜
- æ„å»ºå·¥å…·é€‰ç”¨ parcelï¼Œå·ç§°é›¶é…ç½®
- ä»é›¶åˆ°ä¸€çš„å®ç°ä¸€ä¸ª react
- æ¯ç¯‡æ–‡ç« åœ¨æœ€åï¼Œéƒ½ä¼šé™„ä¸Šå½“å‰ç« èŠ‚æºç  ğŸŒ
- [github æºç ](https://github.com/chao31/Didact)


## åˆ›å»ºä¸€ä¸ªç©ºé¡¹ç›®

åˆ›å»ºé¡¹ç›®å¹¶åˆå§‹åŒ–`package.json`

```bash
mkdir Didact
npm init -y 
```

### å®‰è£… parcel

```js
npm i -D parcel-bundler@^1.12.5
```
**ä¸ºäº†è·Ÿç€æ•™ç¨‹èµ°ä¸ä¼šå› ç‰ˆæœ¬é—®é¢˜æŠ¥é”™ï¼Œæœ¬æ–‡æ¥ä¸‹æ¥çš„æ‰€æœ‰ npm ä¾èµ–éƒ½å°†å¸¦ä¸Šç‰ˆæœ¬å·**

### æ–°å¢ index.html æ¨¡æ¿

æ·»åŠ  html ä»£ç ï¼š

-   æ ¹èŠ‚ç‚¹Â `root`
-   å†…è”çš„æ–¹å¼å¼•å…¥ ä¸€ä¸ª`index.js`

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <title>Didact</title>
  </head>
  <body>
    <div id="root"></div>
  </body>
  <script src="./index.js"></script>
</html>
```

### æ·»åŠ å…¥å£ index.js

`index.js`é‡Œé¢æ˜¯ä¸€æ®µ JSX ä»£ç 

 ```js
console.log('æˆåŠŸå¯åŠ¨'); 
``` 

### å¢åŠ  script å‘½ä»¤

ä¿®æ”¹ package.json

```diff
"scripts": {
+  "start": "parcel index.html",
},
```
æ‰§è¡ŒÂ `npm start`ï¼Œè®¿é—®`http://localhost:1234/`, ä¼šçœ‹åˆ°æ§åˆ¶å°æ‰“å°`"æˆåŠŸå¯åŠ¨" `

## å¦‚ä½•å¤„ç† JSX

### ä»€ä¹ˆæ˜¯ jsxï¼Ÿ

å¦‚ä¸‹å°±æ˜¯ä¸€æ®µ JSX ä»£ç ï¼ŒÂ [å…·ä½“è¯·å‚è€ƒ](https://zh-hans.reactjs.org/docs/introducing-jsx.html)

```js
const profile = (
  <div className="profile">
    <span className="profile-title">title</span>
    <h3 className="profile-content">content</h3>
    æˆ‘æ˜¯ä¸€æ®µæ–‡æœ¬
  </div>
);
```

æ¥ä¸‹æ¥è¦å°†ä¸Šé¢ `JSX` ä»£ç è½¬åŒ–ä¸ºä¸‹é¢çš„`æ•°æ®ç»“æ„`æ¥æè¿°

```js
// å¯¹è±¡æ¥æè¿° jsx
const profile = {
    type:Â "div",
    props: {
       className:Â "profile",
       children:Â [
           {type:Â 'span',Â props:Â {â€¦}},
           {type:Â 'h3',Â props:Â {â€¦}},
           "æˆ‘æ˜¯ä¸€æ®µæ–‡æœ¬"
       ],
   },
}
```

### å®‰è£… babel å¤„ç† JSX

æˆ‘ä»¬ä½¿ç”¨`@babel/preset-react`æ¥è½¬åŒ– jsxï¼Œä½†åŒæ—¶éœ€å®‰è£…å®ƒæ‰€éœ€è¦ä¾èµ–â€”â€”`babel-core`ï¼Œæ‰€ä»¥æ•´ä½“å®‰è£…å‘½ä»¤å¦‚ä¸‹ï¼š

```js
npm i -D @babel/preset-react@^7.17.12 babel-core@^7.0.0-bridge.0
```

ç„¶åå†æ ¹ç›®å½•æ·»åŠ `.babelrc`æ–‡ä»¶ï¼š

```json
{
  "presets": [
    [
      "@babel/preset-react",
      {
        // è¿™æ ·å†™ï¼Œbabelä¼šè°ƒç”¨ Didact.createElementå‡½æ•° æ¥é€’å½’ç”Ÿæˆ jsxå¯¹è±¡
        "pragma": "Didact.createElement"
      }
    ]
  ]
}
```

*æ³¨æ„ï¼šæˆ‘ä»¬åœ¨ä¸Šé¢è®¾ç½®äº†`pragma`å±æ€§ï¼Œå®ƒæŒ‡å®šäº†`babel`é€šè¿‡è°ƒç”¨`Didact.createElement`æ¥é€’å½’JSXï¼Œä»è€Œç”Ÿæˆä¸Šé¢çš„æ•°æ®ç»“æ„ã€‚*

### æµ‹è¯• JSX çš„è½¬æ¢

å°† index.js çš„consoleæ‰“å°æ”¹ä¸ºä¸Šé¢çš„é‚£æ®µ JSX

```diff
- console.log('æˆåŠŸå¯åŠ¨');

+ const profile = (
+   <div className="profile">
+     <span className="profile-title">title</span>
+     <h3 className="profile-content">content</h3>
+     æˆ‘æ˜¯ä¸€æ®µæ–‡æœ¬
+   </div>
+ );

+ console.log('profile: ', profile);
```

æ‰“å¼€æ§åˆ¶å°ï¼Œä¼šçœ‹åˆ°å¦‚ä¸‹é”™è¯¯æç¤ºï¼š

```js
Uncaught ReferenceError: Didact is not defined
    at Object.parcelRequire.index.js (index.js:29:3)
    at newRequire (Didact.e31bb0bc.js:47:24)
    at Didact.e31bb0bc.js:81:7
    at Didact.e31bb0bc.js:120:3
```

ç‚¹å‡»è¿›å…¥ç¬¬ä¸€è¡Œé”™è¯¯å®šä½ï¼Œä¼šè·³è½¬åˆ°æºç å‡ºé”™çš„åœ°æ–¹â€”â€” â€œDidact.createElement æœªå®šä¹‰â€ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æœªå®ç°`Didact.createElement`,æ‰€ä»¥å› æ‰¾ä¸åˆ°è¯¥å‡½æ•°è€ŒæŠ¥é”™ã€‚

ä½†åœ¨å®ç°`createElement`æ–¹æ³•å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹babelæ˜¯å¦‚ä½•å¤„ç†jsxçš„ã€‚

### babelè½¬æ¢jsxçš„è¿‡ç¨‹
babelè°ƒç”¨`Didact.createElement`è½¬æ¢jsxçš„è¿‡ç¨‹å¦‚ä¸‹ï¼š

```js
var profile = Didact.createElement(
  // HTML æ ‡ç­¾çš„ç±»å‹
  "div", 
  // è¯¥ HTML æ ‡ç­¾çš„å±æ€§
  { className: "profile" }, 
  // åé¢éƒ½è¯¥ HTML æ ‡ç­¾çš„ children
  // ç¬¬ä¸€ä¸ª child
  Didact.createElement(
    "span", 
    { className: "profile-title" }, 
    "title"
  ), 
  // ç¬¬äºŒä¸ª child
  Didact.createElement(
    "h3", 
    { className: "profile-content" }, 
    "content"
  ),
  // ç¬¬ä¸‰ä¸ª child
  "æˆ‘æ˜¯ä¸€æ®µæ–‡æœ¬"
);

console.log('profile: ', profile);
// ...
```

ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œ`@babel/preset-react`åšäº†ä¸¤ä»¶äº‹æƒ…ï¼š

-   å°† JSX ä»£ç è½¬æ¢æˆäº†å‚æ•°ï¼Œ`type, props, ...children`
-   å°†ä¸Šé¢çš„å‚æ•°ä¼ é€’ç»™ Didact.createElementï¼Œå¹¶æ‰§è¡Œè¯¥å‡½æ•°

```js
Didact.createElement(
  type,
  [props],
  [...children]
)

// å‚æ•°è¯´æ˜ï¼š

// - typeï¼šæ ‡ç­¾ç±»å‹ï¼Œå¦‚ï¼š`div`ã€`span`ã€`h3`, 
//        ä¹Ÿå¯ä»¥æ˜¯ React ç»„ä»¶ ç±»å‹ï¼ˆclass ç»„ä»¶æˆ–å‡½æ•°ç»„ä»¶ï¼‰
// - props: è¯¥æ ‡ç­¾çš„å±æ€§ï¼Œå¦‚`classname`, è‹¥æ— åˆ™ä¸º null
// - childrenï¼šç¬¬ 2ã€3...ä¸ªå‚æ•°ï¼Œéƒ½æ˜¯å­å…ƒç´ ï¼Œå­å…ƒç´ åˆå¼€å§‹é€’å½’è°ƒç”¨`React.createElement`
```

## å®ç° createElement æ–¹æ³•

å¾ˆç®€å•ï¼Œè®©`Didact.createElement`Â è¿”å›ä¸€ä¸ªå«æœ‰ children çš„æ ‘çŠ¶ç»“æ„ï¼Œå°±å®ç°äº†createElement

åœ¨index.jsä¸­æ·»åŠ ï¼š

```diff
+ function createElement(type, props, ...children) {
+   return {
+     type,
+     props: {
+       ...props,
+       ...children,
+     }
+   };
+ }

+ const Didact = {
+   createElement,
+ };

const profile = (
  <div className="profile">
    <span className="profile-title">title</span>
    <h3 className="profile-content">content</h3>
    æˆ‘æ˜¯ä¸€æ®µæ–‡æœ¬
  </div>
);

console.log('profile: ', profile);
```

è¿™æ ·å°±å®ç°äº†`createElement`æ–¹æ³•ã€‚

ä½†é€šè¿‡consoleæ‰“å°å‘ç°ï¼Œ`children`ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œé™¤äº†`æ–‡æœ¬èŠ‚ç‚¹`æ˜¯`string`å…¶å®ƒèŠ‚ç‚¹éƒ½æ˜¯`å¯¹è±¡`ã€‚

è¿™é‡Œå°†æ–‡æœ¬èŠ‚ç‚¹ä¹Ÿç»Ÿä¸€å¤„ç†æˆå¯¹è±¡ï¼Œè¿™æ ·åé¢ä¼šå°‘äº†å¾ˆå¤š`ifã€else`çš„åˆ¤æ–­ã€‚

å°†æ–‡æœ¬èŠ‚ç‚¹æ„å»ºä¸º`typeï¼š'TEXT_ELEMENT'`çš„å¯¹è±¡ï¼Œä¿®æ”¹ä»£ç ï¼š

```diff
function createElement(type, props, ...children) {
  return {
    type,
    props: {
      ...props,
-      ...children,
+      children: children.map(child =>
+        typeof child === "object" ? child : createTextElement(child)
+      )
    }
  };
}

+ function createTextElement(text) {
+  return {
+    type: "TEXT_ELEMENT",
+    props: {
+      nodeValue: text,
+      children: []
+    }
+  };
+ }

const Didact = {
  createElement,
};

```

è¿™æ ·æˆ‘ä»¬å°±å½»åº•å®Œæˆäº†`createElement`æ–¹æ³•

[æœ¬ç« æºç ](https://github.com/chao31/Didact/blob/feature/chao31_createElement/index.js)

# å®ç° fiber 

## å®ç° render æ–¹æ³•

è¿™é‡Œè¦å®ç°çš„æ˜¯å’Œ `ReactDOM.render`åŒæ ·çš„åŠŸèƒ½ï¼Œä»£ç å¦‚ä¸‹ï¼š

```diff
// ...

+ function render(element, container) {
+   const dom = element.type == "TEXT_ELEMENT"
+     ? document.createTextNode("")
+     : document.createElement(element.type)
+ 
+   // children è¢«æ”¾åˆ°äº† props å±æ€§é‡Œï¼Œè¿™é‡Œè¿‡æ»¤æ‰ children
+   const isProperty = key => key !== "children"
+ 
+   Object.keys(element.props)
+     .filter(isProperty)
+     // è®¾ç½® dom å…ƒç´ çš„å±æ€§ï¼Œè¿™é‡Œæ˜¯ç®€åŒ–ç‰ˆæ„æ€ä¸€ä¸‹ï¼Œç›´æ¥èµ‹å€¼
+     .forEach(name => dom[name] = element.props[name])
+   
+   // é€’å½’å­å…ƒç´ 
+   element.props.children.forEach(child =>render(child, dom))
+ 
+   container.appendChild(dom)
+ }

const profile = (
  <div className="profile">
    <span className="profile-title">title</span>
    <h3 className="profile-content">content</h3>
  </div>
);

console.log('æˆåŠŸå¯åŠ¨', profile);

+ const container = document.getElementById("root")
+ Didact.render(profile, container)
```

- åˆ›å»ºèŠ‚ç‚¹æ—¶ï¼Œä¸åŒç±»å‹çš„èŠ‚ç‚¹ç”¨ä¸åŒæ–¹æ³•åˆ›å»ºï¼Œæ–‡æœ¬èŠ‚ç‚¹ç”¨`createTextNode`ï¼Œå…¶ä»–èŠ‚ç‚¹ç”¨`createElement`
- æˆ‘ä»¬åˆ›å»ºjsxæ•°æ®ç»“æ„æ—¶ï¼Œå°†`children`ç»Ÿä¸€æ”¾åˆ°äº†`props`å±æ€§é‡Œï¼Œæ‰€ä»¥ç»™domæ·»åŠ `props`å‰ï¼Œéå†`props`æ—¶ï¼Œéœ€è¿‡æ»¤æ‰`props`é‡Œçš„`children`
- è¿™é‡Œç»™domæ·»åŠ `props`å±æ€§çš„å®ç°éå¸¸ç®€å•ï¼Œåªæœ‰ä¸€ä¸ªèµ‹å€¼è¡¨è¾¾å¼`dom[name] = element.props[name]`ï¼Œå…¶å®æ˜¯æƒ³ç”¨ä¸€è¡Œä»£ç æ¥ä»£è¡¨æ­¤å¤„è¿˜æœ‰ç€å†—æ‚çš„å±æ€§å¤„ç†ï¼Œä½†å†™å¤ªå¤æ‚å¯¹ç†è§£æ•´ä½“reactæºç æ²¡æœ‰å¸®åŠ©ï¼Œä½†æ„Ÿå…´è¶£å¯ä»¥[é˜…è¯»](https://stackoverflow.com/questions/6003819/what-is-the-difference-between-properties-and-attributes-in-html)ã€‚

è¿™æ ·å¤§å®¶å°±å¯ä»¥çœ‹åˆ°é¡µé¢å·²ç»è¢«æ¸²æŸ“å‡ºæ¥äº†ï¼Œå¦‚ä¸‹å›¾ï¼š


![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d28d2cef7770440995c29d81f2d793bf~tplv-k3u1fbpfcp-watermark.image?)

æˆªæ­¢åˆ°æ­¤å¤„çš„[æºç ](https://github.com/chao31/Didact/blob/feature/chao31_render/index.js)

## ä¸ºä»€ä¹ˆè¦å¼•å…¥fiber

æˆ‘ä»¬çš„`render`æ–¹æ³•æ˜¯ç”¨`é€’å½’`å®ç°çš„ï¼Œé‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œä¸€æ—¦å¼€å§‹é€’å½’ï¼Œå°±ä¸ä¼šåœæ­¢ï¼Œç›´è‡³æ¸²æŸ“å®Œæ•´ä¸ªdomæ ‘ã€‚

é‚£å¦‚æœdomæ ‘å¾ˆå¤§ï¼Œjså°±ä¼šå æ®ç€ä¸»çº¿ç¨‹ï¼Œè€Œæ— æ³•åšå…¶ä»–å·¥ä½œï¼Œæ¯”å¦‚`ç”¨æˆ·çš„äº¤äº’å¾—ä¸åˆ°å“åº”`ã€`åŠ¨ç”»ä¸èƒ½ä¿æŒæµç•…`ï¼Œå› ä¸ºå®ƒä»¬å¿…é¡»ç­‰å¾…æ¸²æŸ“å®Œæˆã€‚ä¸ºäº†å±•ç¤ºè¿™ä¸ªé—®é¢˜ï¼Œä¸‹é¢æœ‰ä¸ª[å°æ¼”ç¤º](https://pomber.github.io/incremental-rendering-demo/react-sync.html)ï¼š

>ä¸ºäº†ä¿æŒè¡Œæ˜Ÿçš„æ—‹è½¬ï¼Œä¸»çº¿ç¨‹éœ€è¦åœ¨æ¯16mså·¦å³å°±è¦è¿è¡Œä¸€æ¬¡ã€‚å¦‚æœä¸»çº¿ç¨‹è¢«å…¶ä»–ä¸œè¥¿é˜»å¡, æ¯”å¦‚è®¾ç½®äº†ä¸»çº¿ç¨‹å ç”¨200æ¯«ç§’, å¤§å®¶å°±ä¼šå‘ç°åŠ¨ç”»å¼€å§‹ä¸¢å¤±å¸§çš„ç°è±¡â€”â€”è¡Œæ˜Ÿä¼šå‘ç”Ÿå†»ç»“ã€å¡é¡¿ï¼Œç›´åˆ°ä¸»çº¿ç¨‹å†æ¬¡è¢«é‡Šæ”¾ã€‚

æ­£æ˜¯å› ä¸ºreactçš„æ¸²æŸ“ä¼šé˜»å¡ä¸»çº¿ç¨‹å¤ªä¹…ï¼Œæ‰€ä»¥å‡ºç°äº†`react fiber`ã€‚

## fiberæ˜¯ä»€ä¹ˆ

`react fiber`æ²¡æ³•`ç¼©çŸ­`æ•´é¢—æ ‘çš„æ¸²æŸ“æ—¶é—´ï¼Œä½†å®ƒä½¿å¾—æ¸²æŸ“è¿‡ç¨‹è¢«åˆ†æˆä¸€å°æ®µã€ä¸€å°æ®µçš„ï¼Œç›¸å½“äºæœ‰äº† â€œä¿å­˜å·¥ä½œè¿›åº¦â€ çš„èƒ½åŠ›ï¼Œjsæ¯æ¸²æŸ“å®Œä¸€ä¸ªå•å…ƒèŠ‚ç‚¹ï¼Œå°±è®©å‡ºä¸»çº¿ç¨‹ï¼Œä¸¢ç»™æµè§ˆå™¨å»åšå…¶ä»–å·¥ä½œï¼Œç„¶åå†å›æ¥ç»§ç»­æ¸²æŸ“ï¼Œä¾æ¬¡å¾€å¤ï¼Œç›´è‡³æ¯”è¾ƒå®Œæˆï¼Œæœ€åä¸€æ¬¡æ€§çš„æ›´æ–°åˆ°è§†å›¾ä¸Šã€‚

ä¸‹é¢ç”¨ä¸€æ®µä¼ªä»£ç æ¥ç†è§£è¿™ä¸ªæ‹†åˆ†è¿‡ç¨‹ï¼š

```js
// è¢«æ‹†åˆ†æˆçš„ä¸€ä¸ªä¸€ä¸ªå•å…ƒçš„å°ä»»åŠ¡
let nextUnitOfWork = null

function workLoop(deadline) {
  // requestIdleCallback ç»™ shouldYield èµ‹å€¼ï¼Œå‘Šè¯‰æˆ‘ä»¬æµè§ˆå™¨æ˜¯å¦ç©ºé—²
  let shouldYield = false
  while (nextUnitOfWork && !shouldYield) {
    nextUnitOfWork = performUnitOfWork(nextUnitOfWork)
    shouldYield = deadline.timeRemaining() < 1
  }
  // å¾ªç¯è°ƒç”¨ workLoop
  requestIdleCallback(workLoop)
}

requestIdleCallback(workLoop)

// æ¯æ¬¡æ‰§è¡Œå®Œä¸€ä¸ªå•å…ƒä»»åŠ¡ï¼Œä¼šè¿”å›ä¸‹ä¸€ä¸ªå•å…ƒä»»åŠ¡
function performUnitOfWork(nextUnitOfWork) {
  // TODO
}
```

ä¸ç†Ÿæ‚‰ **requestIdleCallback** å¯ä»¥[ç‚¹è¿™é‡ŒæŸ¥çœ‹](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback)ï¼Œ è¿™ä¸ªæ–¹æ³•å¾ˆç®€å•ï¼šå®ƒéœ€è¦ä¼ å…¥ä¸€ä¸ª **callback**ï¼Œæµè§ˆå™¨ä¼šåœ¨ç©ºé—²æ—¶å»è°ƒç”¨è¿™ä¸ª **callback**ï¼Œ ç„¶åç»™è¿™ä¸ª**callback** ä¼ å…¥ä¸€ä¸ª [IdleDeadline](https://developer.mozilla.org/zh-CN/docs/Web/API/IdleDeadline)ï¼Œ`IdleDeadline` ä¼šé¢„ä¼°ä¸€ä¸ªå‰©ä½™é—²ç½®æ—¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿˜å‰©å¤šå°‘é—²ç½®æ—¶é—´å»åˆ¤æ–­ï¼Œæ˜¯å¦è¶³å¤Ÿå»æ‰§è¡Œä¸‹ä¸€ä¸ª`å•å…ƒä»»åŠ¡`ã€‚

## fiberçš„æ•°æ®ç»“æ„

ä¸ºäº†èƒ½æ‹†åˆ†æˆä¸Šé¢çš„`å•å…ƒä»»åŠ¡`ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ–°çš„æ•°æ®ç»“æ„â€”â€”`fiberé“¾è¡¨`ï¼Œä¾‹å¦‚æˆ‘ä»¬è¦æ¸²æŸ“å¦‚ä¸‹å…ƒç´ ï¼š

```js
Didact.render(
  <div>
    <h1>
      <p />
      <a />
    </h1>
    <h2 />
  </div>,
  container
)
```

å®ƒè¢«è½¬åŒ–æˆçš„`fiber é“¾è¡¨`çš„ç»“æ„å¦‚ä¸‹ï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/57137a19680747a985cdf30b90427ad8~tplv-k3u1fbpfcp-watermark.image?)

- æˆ‘ä»¬ç”¨`fiber`æ¥ä»£æŒ‡ä¸€ä¸ªè¦å¤„ç†çš„`å•å…ƒä»»åŠ¡`ï¼Œå¦‚ï¼šä¸Šé¢çš„ä¸€ä¸ª`h1`å°±æ˜¯ä¸€ä¸ª`fiber`
- å‡ ä¹æ¯ä¸€ä¸ª`fiber`éƒ½æœ‰3ä¸ªæŒ‡é’ˆï¼Œæ‰€ä»¥æ¯ä¸ª`fiber`éƒ½å¯ä»¥æ‰¾åˆ°å®ƒçš„çˆ¶ã€å­(ç¬¬ä¸€ä¸ªå­å…ƒç´ )ã€å…„å¼Ÿå…ƒç´ ï¼ˆè¿™ä¹Ÿæ˜¯æ¸²æŸ“å¯ä»¥ä¸­æ–­çš„åŸå› ï¼‰
- æ¯å½“æ¸²æŸ“å®Œä¸€ä¸ª`fiber`ï¼Œ`performUnitOfWork`éƒ½ä¼šè¿”å›ä¸‹ä¸€ä¸ªå¾…å¤„ç†çš„`fiber`ï¼Œæµè§ˆå™¨é—²æ—¶å°±ä¼šå»å¤„ç†ä¸‹ä¸€ä¸ª`fiber`ï¼Œä»¥æ­¤å¾ªç¯
- ä¼˜å…ˆè¿”å›`child fiber`åšä¸ºä¸‹ä¸€ä¸ªå¾…å¤„ç†çš„`fiber`ï¼›è‹¥`child fiber`ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›`å…„å¼Ÿ fiber`ï¼›è‹¥`å…„å¼Ÿ fiber`ä¸å­˜åœ¨ï¼Œåˆ™å¾€ä¸Šé€’å½’ï¼Œæ‰¾çˆ¶å…ƒç´ çš„`å…„å¼Ÿ fiber`ï¼›ä»¥æ­¤å¾ªç¯...

ä¾‹å¦‚ï¼š
- å½“å‰æ¸²æŸ“äº†`div`ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªè¦å¤„ç†çš„å°±æ˜¯`h1 fiber`
- å¦‚æœ`child fiber`ä¸å­˜åœ¨ï¼Œå¦‚ `p fiber`,åˆ™ä¸‹ä¸€ä¸ªè¦å¤„ç†çš„æ˜¯å…„å¼Ÿ`a fiber`
- å¦‚æœ`child fiber`å’Œ`å…„å¼Ÿ fiber`éƒ½ä¸å­˜åœ¨ï¼Œå¦‚ï¼š`a fiber`ï¼Œåˆ™å¾€ä¸Šæ‰¾`å”å” fiber`ï¼Œå³`h2 fiber`

## å®ç° fiber
åœ¨`render`æ–¹æ³•é‡Œä¸º`nextUnitOfWork`èµ‹å€¼ç¬¬ä¸€ä¸ª`fiber`ï¼Œå¾…æµè§ˆå™¨é—²æ—¶æ£€æµ‹åˆ°äº†`nextUnitOfWork`æœ‰å€¼ï¼Œå°±ä¼šå¯åŠ¨loopå¾ªç¯ï¼Œä¸æ–­åœ°è®¾ç½®ä¸‹ä¸€ä¸ª`fiber`ï¼Œä¹Ÿä¸æ–­çš„éå†å…¨éƒ¨èŠ‚ç‚¹ï¼Œä»£ç å¦‚ä¸‹ï¼š

```js
function createDom(fiber) {
  const dom =
      fiber.type == "TEXT_ELEMENT"
        ? document.createTextNode("")
        : document.createElement(fiber.type)

  // children è¢«æ”¾åˆ°äº† props å±æ€§é‡Œï¼Œè¿™é‡Œè¿‡æ»¤æ‰ children
  const isProperty = key => key !== "children"

  Object.keys(fiber.props)
    .filter(isProperty)
    // è®¾ç½® dom å…ƒç´ çš„å±æ€§ï¼Œè¿™é‡Œæ˜¯ç®€åŒ–ç‰ˆæ„æ€ä¸€ä¸‹ï¼Œç›´æ¥èµ‹å€¼
    .forEach(name => dom[name] = fiber.props[name])
  
  return dom
}

function render(element, container) {
  // è™½ç„¶åé¢ä¼šç»™è¿™ä¸ªå¯¹è±¡æ·»åŠ æ›´å¤šå±æ€§ï¼Œä½†è¿™é‡Œæ˜¯ç¬¬ä¸€ä¸ª fiber
  nextUnitOfWork = {
    dom: container,
    props: {
      children: [element],
    },
  }
}
```
- ä¿®æ”¹`render`æ–¹æ³•ï¼šè®¾ç½®å¾…æ‰§è¡Œçš„åˆå§‹`fiber`
- æ–°å¢`createDom`æ–¹æ³•ï¼š å°†åŸ `render` æ–¹æ³•é‡Œçš„ä¸»è¦é€»è¾‘ç§»åˆ° `createDom` ä¸­ï¼Œå³æ ¹æ® `fiber` çš„å±æ€§ï¼Œåˆ›å»º `domèŠ‚ç‚¹`


å®ç° `performUnitOfWork` æ–¹æ³•ï¼š

```js
// æ¯æ¬¡æ‰§è¡Œå®Œä¸€ä¸ªå•å…ƒä»»åŠ¡ï¼ˆåšäº†ä»¥ä¸‹ 3 ä»¶äº‹ï¼‰ï¼Œä¼šè¿”å›ä¸‹ä¸€ä¸ªå•å…ƒä»»åŠ¡
// 1. ç»™ fiber æ·»åŠ  domï¼Œå¹¶æ’å…¥çˆ¶å…ƒç´ 
// 2. ç»™å½“å‰ fiber çš„æ¯ä¸€ä¸ªå­å…ƒç´ ç”Ÿæˆ fiber èŠ‚ç‚¹
// 3. æ‰¾åˆ°è¦è¿”å›çš„ä¸‹ä¸€ä¸ª unitOfWork
function performUnitOfWork(fiber) {
  if (!fiber.dom) {
    fiber.dom = createDom(fiber)
  }

  if (fiber.parent) {
    fiber.parent.dom.appendChild(fiber.dom)
  }

  const elements = fiber.props.children
  let index = 0
  let prevSibling = null

  // 1. éå†å½“å‰ fiber çš„ children
  // 2. ç»™ children é‡Œçš„æ¯ä¸ª child æŒ‡å®š 3 ä¸ªæŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘å…¶ çˆ¶ã€å­ã€å…„å¼Ÿä¸‰ä¸ªèŠ‚ç‚¹
  while (index < elements.length) {
    const element = elements[index]

    const newFiber = {
      type: element.type,
      props: element.props,
      parent: fiber,
      dom: null,
    }

    if (index === 0) {
      fiber.child = newFiber
    } else {
      prevSibling.sibling = newFiber
    }

    prevSibling = newFiber
    index++
  }

  // ä¸‹é¢çš„æ“ä½œæ˜¯è¿”å›ä¸‹ä¸€ä¸ªå•å…ƒâ€”â€”nextUnitOfWork
  // 1. ä¼˜å…ˆæ‰¾ child
  // 2. æ²¡æœ‰ child æ‰¾å…„å¼Ÿ
  // 3. æ²¡æœ‰å…„å¼Ÿï¼Œæ‰¾å”å”ï¼Œä¹Ÿå°±æ˜¯é€’å½’åˆ°çˆ¶å…ƒç´ çš„å…„å¼Ÿ
  // 4. æ²¡æœ‰å”å”å°±ä¸€ç›´å¾€ä¸Šé€’å½’...
  if (fiber.child) {
    return fiber.child
  }
  let nextFiber = fiber
  while (nextFiber) {
    if (nextFiber.sibling) {
      return nextFiber.sibling
    }
    nextFiber = nextFiber.parent
  }
}
```
é‡Œé¢çš„æ³¨é‡Šå¾ˆè¯¦å°½ï¼Œå°±ä¸å†è®²è¿° `performUnitOfWork` çš„å®ç°äº†ã€‚

## UIå±•ç¤ºä¸å®Œæ•´é—®é¢˜

ä»ä¸‹é¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸ª`fiber`éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡æ’å…¥domï¼Œä½†å› æ¸²æŸ“æ˜¯ä¼šè¢«æ‰“æ–­çš„ï¼Œæ‰€ä»¥å°±ä¼šå‡ºç°åªæ’å…¥éƒ¨åˆ†domçš„æƒ…å†µï¼Œä½¿æŸä¸€åˆ»çš„UIå®Œæ•´ä¸å±•ç¤ºã€‚

```diff
function performUnitOfWork(fiber) {
// ...

- if (fiber.parent) {
-     fiber.parent.dom.appendChild(fiber.dom)
- }

//...
}
```


æ‰€ä»¥è¦åˆ é™¤ä¸Šé¢çš„å®ç°ï¼Œè½¬è€Œé€šè¿‡åˆ¤æ–­rootèŠ‚ç‚¹æ˜¯å¦å…¨éƒ¨æ¸²æŸ“å®Œæˆï¼Œè‹¥å…¨éƒ¨å®Œæˆï¼Œå†å°†æ•´ä¸ª`root fiber`æ’å…¥domï¼Œå®ç°å¦‚ä¸‹ï¼š

```diff
function render(element, container) {
-  nextUnitOfWork = {
+  wipRoot = {
     dom: container,
     props: {
       children: [element],
     },
   }
+  nextUnitOfWork = wipRoot
}

+ function commitRoot() {
+   commitWork(wipRoot.child)
+   wipRoot = null
+ }

+ // é€’å½’æ’å…¥æ‰€æœ‰ dom
+ function commitWork(fiber) {
+   if (!fiber) return
+   
+   const domParent = fiber.parent.dom
+   domParent.appendChild(fiber.dom)
+   commitWork(fiber.child)
+   commitWork(fiber.sibling)
+ }

// è¢«æ‹†åˆ†æˆçš„ä¸€ä¸ªä¸€ä¸ªå•å…ƒçš„å°ä»»åŠ¡
let nextUnitOfWork = null

+ let wipRoot = null

function workLoop(deadline) {
  // requestIdleCallback ç»™ shouldYield èµ‹å€¼ï¼Œå‘Šè¯‰æˆ‘ä»¬æµè§ˆå™¨æ˜¯å¦ç©ºé—²
  let shouldYield = false
  while (nextUnitOfWork && !shouldYield) {
    nextUnitOfWork = performUnitOfWork(nextUnitOfWork)
    shouldYield = deadline.timeRemaining() < 1
  }

+ // æ²¡æœ‰ä¸‹ä¸€ä¸ªå¾…æ¸²æŸ“çš„ fiberï¼Œè¡¨ç¤ºæ‰€æœ‰ dom æ¸²æŸ“å®Œæˆï¼Œcommit åˆ° root
+ if (!nextUnitOfWork && wipRoot) {
+   commitRoot()
+ }
  
  // å¾ªç¯è°ƒç”¨ workLoop
  requestIdleCallback(workLoop)
}

```
é€šè¿‡ä¸Šé¢æœ€åçš„ `commitRoot` æ–¹æ³•ï¼Œå°†å®Œæ•´çš„ `root fiber` é‡Œçš„æ‰€æœ‰ `dom` é€šè¿‡é€’å½’æ’å…¥åˆ°äº†é¡µé¢ï¼Œå°±ä¿®å¤äº† UI å‡ºç°ä¸å®Œæ•´å±•ç¤ºçš„é—®é¢˜ã€‚

[æœ¬ç« æºç ](https://github.com/chao31/Didact/blob/feature/chao31_fiber/index.js)



---
å‚è€ƒï¼š
1. [build your own react](https://pomb.us/build-your-own-react/)
2. [Fibre-é€’å¢å¯¹æ¯”](https://github.com/chinanf-boy/didact-explain/blob/master/5.Fibre.readme.md)
3. [æœ‰ React fiberï¼Œä¸ºä»€ä¹ˆä¸éœ€è¦ Vue fiberï¼Ÿ](https://mp.weixin.qq.com/s/K8mHbIwR6NMaIrutDzg61A)


# å®ç°diff

æˆªæ­¢åˆ°ç›®å‰ï¼Œæˆ‘ä»¬çš„reactå·²ç»å¯ä»¥å®Œæˆé¦–æ¬¡æ¸²æŸ“ï¼Œä½†è¿˜ä¸èƒ½å“åº”å¼æ›´æ–°å’Œåˆ é™¤ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹ã€‚

## ä¿å­˜ old fiber

```diff
// ...

function render(element, container) {
  // è™½ç„¶åé¢ä¼šç»™è¿™ä¸ªå¯¹è±¡æ·»åŠ æ›´å¤šå±æ€§ï¼Œä½†è¿™é‡Œæ˜¯ç¬¬ä¸€ä¸ª fiber
  wipRoot = {
    dom: container,
    props: {
      children: [element],
    },
+   alternate: currentRoot,
  }
  nextUnitOfWork = wipRoot
}

 function commitRoot() {
   commitWork(wipRoot.child)
+  // commit åï¼Œæ–° fiber å°±å˜æˆäº†æ—§ fiberï¼Œæ›´æ–°ä¸€ä¸‹æ—§ fiber
+  currentRoot = wipRoot
   wipRoot = null
 }

// ...

let nextUnitOfWork = null
+ // å½“æœ‰æ–° fiber root åï¼Œä¼šæ‹¿å®ƒè·Ÿå½“å‰ root fiber åšå¯¹æ¯”ï¼Œæ‰€ä»¥éœ€è¦ç¼“å­˜å½“å‰ root fiber
+ let currentRoot = null
let wipRoot = null

//...
```
- ç¼“å­˜å½“å‰çš„`root fiber`ï¼Œä»¥ä¾¿æœ‰äº†æ–°çš„`root fiber`åå¯ä»¥è¿›è¡Œ`diff`
- ç»™æ¯ä¸€ä¸ªfiberéƒ½æ–°å¢ä¸€ä¸ª`alternate`å±æ€§ï¼Œç”¨äºå­˜æ”¾æ—§fiber

## æå–difféƒ¨åˆ†å¹¶è¿›è¡Œå°è£…

ä¹‹å‰æˆ‘ä»¬å¤„ç†difféƒ¨åˆ†æ˜¯åœ¨`performUnitOfWork`æ–¹æ³•é‡Œï¼Œç°åœ¨å°†å…¶æå‡ºæ¥ï¼Œå°è£…åˆ°æ–°æ–¹æ³•`reconcileChildren`é‡Œ

```diff
function performUnitOfWork(fiber) {
  if (!fiber.dom) {
    fiber.dom = createDom(fiber)
  }

  const elements = fiber.props.children

+  reconcileChildren(fiber, elements)

-    let index = 0
-    let prevSibling = null

-    // 1. éå†å½“å‰ fiber çš„ children
-    // 2. ç»™ children é‡Œçš„æ¯ä¸ª child æŒ‡å®š 3 ä¸ªæŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘å…¶ çˆ¶ã€å­ã€å…„å¼Ÿä¸‰ä¸ªèŠ‚ç‚¹
-    while (index < elements.length) {
-      const element = elements[index]

-      const newFiber = {
-        type: element.type,
-        props: element.props,
-        parent: fiber,
-        dom: null,
-      }

-      if (index === 0) {
-        fiber.child = newFiber
-      } else {
-        prevSibling.sibling = newFiber
-      }

-      prevSibling = newFiber
-      index++
-    }

  // ä¸‹é¢çš„æ“ä½œæ˜¯è¿”å›ä¸‹ä¸€ä¸ªå•å…ƒâ€”â€”nextUnitOfWork
  // 1. ä¼˜å…ˆæ‰¾ child
  // 2. æ²¡æœ‰ child æ‰¾å…„å¼Ÿ
  // 3. æ²¡æœ‰å…„å¼Ÿï¼Œæ‰¾å”å”ï¼Œä¹Ÿå°±æ˜¯é€’å½’åˆ°çˆ¶å…ƒç´ çš„å…„å¼Ÿ
  // 4. æ²¡æœ‰å”å”å°±ä¸€ç›´å¾€ä¸Šé€’å½’...
  if (fiber.child) {
    return fiber.child
  }
  // ...
}
  
+ function reconcileChildren(wipFiber, elements) {
+     let index = 0
+     let prevSibling = null
+     ...
+ }
```

åœ¨ `reconcileChildren` æ–¹æ³•ä¸­ï¼ŒæŠŠ `new fiber` å’Œ `old fiber` è¡¨ç¤ºå‡ºæ¥(ä¾¿äºTODOéƒ¨åˆ†è¿›è¡Œå¯¹æ¯”)ï¼Œå¹¶å°†`old fiber`çš„å˜åŒ–ä¹ŸåŠ å…¥åˆ°`while`è¿­ä»£ä¸­æ¥

```diff
function reconcileChildren(wipFiber, elements) {
  let index = 0
+ // ä» alternate æ‰¾åˆ°æ—§çˆ¶ fiber çš„ç¬¬ä¸€ä¸ª childï¼Œä½œä¸ºç¬¬ä¸€ä¸ªè¦å¯¹æ¯”çš„ old fiber
+ let oldFiber = wipFiber.alternate && wipFiber.alternate.child
  let prevSibling = null

  // 1. éå†å½“å‰ fiber çš„ children
  // 2. ç»™ children é‡Œçš„æ¯ä¸ª child æŒ‡å®š 3 ä¸ªæŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘å…¶ çˆ¶ã€å­ã€å…„å¼Ÿä¸‰ä¸ªèŠ‚ç‚¹
-  while (index < elements.length) {
+  while (index < elements.length || oldFiber != null) {
    const element = elements[index]

+    let newFiber = null
-    const newFiber = {
-      type: element.type,
-      props: element.props,
-      parent: wipFiber,
-      dom: null,
-    }

+ // TODO diff éƒ¨åˆ†å°†åœ¨è¿™é‡Œå®ç°

+    if (oldFiber) {
+        oldFiber = oldFiber.sibling
+    }
    
    if (index === 0) {
      wipFiber.child = newFiber
    } else {
      prevSibling.sibling = newFiber
    }

    prevSibling = newFiber
    index++
  }
}
```
ä¸‹é¢æˆ‘ä»¬æ¥å®Œæˆ `reconcileChildren` æ–¹æ³•é‡Œçš„*TODO*éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯diff

## diff

è¿™é‡Œçš„diffä¸»è¦æ˜¯æ›´æ–°fiberçš„å±æ€§ï¼Œè¿˜æ²¡æœ‰åˆ°çœŸå®çš„æ“ä½œdom

### å¯¹æ¯”çš„ç­–ç•¥

- æ–°ã€è€fiberçš„typeç›¸åŒï¼š ä¿ç•™domï¼Œæ›´æ–°å±æ€§
- æ–°ã€è€fiberçš„typeä¸åŒï¼š åˆ›å»ºæ–°fiberï¼Œåˆ é™¤æ—§fiber

ä¸‹é¢å†™å‡ºå¤§ä½“æ¡†æ¶
```diff
while (index < elements.length || oldFiber != null) {
    const element = elements[index]

    let newFiber = null
    
+   const sameType =
+   oldFiber &&
+   element &&
+   element.type == oldFiber.type

+   if (sameType) {
     // TODO update the node
+   }
+   if (element && !sameType) {
     // TODO add this node
+   }
+   if (oldFiber && !sameType) {
     // TODO delete the oldFiber's node
+   }
    
    if (oldFiber) {
      oldFiber = oldFiber.sibling
    }

    if (index === 0) {
      wipFiber.child = newFiber
    } else {
      prevSibling.sibling = newFiber
    }

    prevSibling = newFiber
    index++
}
```

### å¯¹æ¯”æ—§fiberï¼Œåˆ›å»ºæ–°fiber

ä¸‹é¢æˆ‘ä»¬æ¥å®Œæˆä¸Šé¢3ä¸ª *TODO* éƒ¨åˆ†ï¼š

```js
const sameType =
  oldFiber &&
  element &&
  element.type == oldFiber.type

if (sameType) {
  newFiber = {
    type: oldFiber.type,
    props: element.props,
    dom: oldFiber.dom,
    parent: wipFiber,
    alternate: oldFiber,
    effectTag: "UPDATE",
  }
}
if (element && !sameType) {
  newFiber = {
    type: element.type,
    props: element.props,
    dom: null,
    parent: wipFiber,
    alternate: null,
    effectTag: "PLACEMENT",
  }
}
if (oldFiber && !sameType) {
  oldFiber.effectTag = "DELETION"
  deletions.push(oldFiber)
}
```

- ç»™æ¯ä¸ªfiberæ–°å¢äº†`effectTag`å±æ€§ï¼Œåé¢ç»Ÿä¸€å¤„ç†çš„æ—¶å€™ï¼Œå°±çŸ¥é“æ˜¯`æ›´æ–°`ã€`åˆ é™¤`è¿˜æ˜¯`æ’å…¥`
- æ–°å¢äº†`deletions`æ•°ç»„ï¼Œå­˜æ”¾æ‰€æœ‰å¾…åˆ é™¤çš„`fiber`ï¼Œåé¢ç»Ÿä¸€åˆ é™¤é‡Œé¢çš„`dom`

ä¸Šé¢çš„ä»£ç å·²ç»å®Œæˆäº†è¿­ä»£æ‰€æœ‰æ—§fiberï¼Œå¹¶å°†å…¶æ›´æ–°ä¸ºäº†æ–°fiber

### å¤„ç†deletionsæ•°ç»„

æ¸…ç©º`deletions`æ•°ç»„å°†åœ¨ `commit` è¿™ä¸ªé˜¶æ®µè¿›è¡Œå¤„ç†ï¼Œ è€Œæˆ‘ä»¬ä¼šå°†åŒ…æ‹¬åˆ é™¤åœ¨å†…çš„æ‰€æœ‰æ›´æ–°æ“ä½œéƒ½æ”¾åˆ°`commitWork`æ–¹æ³•é‡Œå»åš
```diff
function render(element, container) {
  // è™½ç„¶åé¢ä¼šç»™è¿™ä¸ªå¯¹è±¡æ·»åŠ æ›´å¤šå±æ€§ï¼Œä½†è¿™é‡Œæ˜¯ç¬¬ä¸€ä¸ª fiber
  wipRoot = {
    dom: container,
    props: {
      children: [element],
    },
    alternate: currentRoot,
  }
+ deletions = []
  nextUnitOfWork = wipRoot
}

function commitRoot() {
+  deletions.forEach(commitWork)
  commitWork(wipRoot.child)
  currentRoot = wipRoot
  wipRoot = null
}

let nextUnitOfWork = null
let currentRoot = null
let wipRoot = null
+ let deletions = null
```

### commitWork

ä¸‹é¢æˆ‘ä»¬æ¥å®Œå–„ `commitWork` æ–¹æ³•ï¼Œ`commitWork`é™¤äº†æ’å…¥ï¼Œè¿˜æœ‰åˆ é™¤å’Œæ›´æ–°
```diff
function commitWork(fiber) {
  if (!fiber) return

  const domParent = fiber.parent.dom
- domParent.appendChild(fiber.dom)
+ if ( fiber.effectTag === "PLACEMENT" && fiber.dom != null) {
+   // æ’å…¥æ–° dom
+   domParent.appendChild(fiber.dom)
+ } else if (fiber.effectTag === "UPDATE" && fiber.dom != null) {
+   // æ›´æ–° dom å±æ€§
+   updateDom(
+     fiber.dom,
+     fiber.alternate.props,
+     fiber.props
+   )
+ } else if (fiber.effectTag === "DELETION") {
+   // åˆ é™¤ dom
+   domParent.removeChild(fiber.dom)
+ }
  commitWork(fiber.child)
  commitWork(fiber.sibling)
}

+ function updateDom(dom, prevProps, nextProps) {
+   // TODO
+ }
```

### updateDom

ä¸Šé¢æ–°å¢äº†ä¸€ä¸ª `updateDom` æ–¹æ³•ï¼Œ`updateDom` ä¼šå°†æ‰€æœ‰çš„diffçœŸå®ååº”åˆ°çš„domä¸Šï¼Œç°åœ¨æˆ‘ä»¬æ¥å®ç°å®ƒï¼š

```js
// åˆ¤æ–­æ˜¯å¦æ˜¯ dom äº‹ä»¶
const isEvent = key => key.startsWith("on")
// ä¸æ˜¯ dom äº‹ä»¶ï¼Œä¹Ÿä¸æ˜¯ children å±æ€§ï¼Œæ‰æ˜¯è¦æ›´æ–°çš„å±æ€§
const isProperty = key =>
  key !== "children" && !isEvent(key)
// åˆ¤æ–­æ˜¯å¦æ˜¯æ–°å±æ€§
const isNew = (prev, next) => key =>
  prev[key] !== next[key]
// åˆ¤æ–­å±æ€§æ˜¯å¦è¢«åˆ é™¤
const isGone = (prev, next) => key => !(key in next)
function updateDom(dom, prevProps, nextProps) {
  // åˆ é™¤æ—§çš„ dom äº‹ä»¶ç›‘å¬å‡½æ•°
  Object.keys(prevProps)
    .filter(isEvent)
    .filter(
      key =>
        !(key in nextProps) ||
        isNew(prevProps, nextProps)(key)
    )
    .forEach(name => {
      const eventType = name
        .toLowerCase()
        .substring(2)
      dom.removeEventListener(
        eventType,
        prevProps[name]
      )
    })

  // åˆ é™¤æ—§çš„å±æ€§
  Object.keys(prevProps)
    .filter(isProperty)
    .filter(isGone(prevProps, nextProps))
    .forEach(name => {
      dom[name] = ""
    })

  // è®¾ç½®æ–°çš„å±æ€§
  Object.keys(nextProps)
    .filter(isProperty)
    .filter(isNew(prevProps, nextProps))
    .forEach(name => {
      dom[name] = nextProps[name]
    })
  
  // è®¾ç½®æ–°çš„ dom äº‹ä»¶ç›‘å¬å‡½æ•°
  Object.keys(nextProps)
    .filter(isEvent)
    .filter(isNew(prevProps, nextProps))
    .forEach(name => {
      const eventType = name
        .toLowerCase()
        .substring(2)
      dom.addEventListener(
        eventType,
        nextProps[name]
      )
    })
}
```
å®ç°å¾ˆç®€å•ç²—æš´ï¼šåˆ é™¤æ—§å±æ€§ï¼Œåˆ›å»ºæ–°å±æ€§

æœ€åå°† `createDom` é‡Œçš„domæ›´æ–°ï¼Œä¹Ÿæ”¹ä¸ºä½¿ç”¨ `updateDom`ï¼š

```diff
function createDom(fiber) {
  const dom =
      fiber.type == "TEXT_ELEMENT"
        ? document.createTextNode("")
        : document.createElement(fiber.type)

+  updateDom(dom, {}, fiber.props);
-  // children è¢«æ”¾åˆ°äº† props å±æ€§é‡Œï¼Œè¿™é‡Œè¿‡æ»¤æ‰ children
-  const isProperty = key => key !== "children"

-  Object.keys(fiber.props)
-    .filter(isProperty)
-    // è®¾ç½® dom å…ƒç´ çš„å±æ€§ï¼Œè¿™é‡Œæ˜¯ç®€åŒ–ç‰ˆæ„æ€ä¸€ä¸‹ï¼Œç›´æ¥èµ‹å€¼
-    .forEach(name => dom[name] = fiber.props[name])
  
  return dom
}
```


ç°åœ¨ï¼Œæˆ‘ä»¬çš„ diff åŸºæœ¬å®ç°

[æœ¬ç« æºç ](https://github.com/chao31/Didact/blob/feature/chao31_diff/index.js)


# final

æˆªæ­¢ç›®å‰ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥æ¸²æŸ“htmlæ ‡ç­¾ç»„ä»¶äº†ï¼Œä½†è¿˜ä¸æ”¯æŒreactçš„å‡½æ•°ç»„ä»¶ï¼Œæˆ‘ä»¬æ›¿æ¢ä¸€ä¸‹è¯•è¯•

```diff
- const profile = (
-  <div className="profile">
-    <span className="profile-title">title</span>
-     <h3 className="profile-content">content</h3>
-     æˆ‘æ˜¯ä¸€æ®µæ–‡æœ¬
-  </div>
- );

+ function App(props) {
+   return <h1>Hi {props.name}</h1>
+ }
+ const profile = <App name="foo" />

const container = document.getElementById("root")
Didact.render(profile, container)
```
ä¼šå‘ç°æŠ¥é”™äº†ï¼Œå› ä¸ºå‡½æ•°ç»„ä»¶è¦æ‰§è¡Œä¸€ä¸‹ï¼Œæ‰ä¼šè¿”å›jsx

## æ”¯æŒå‡½æ•°ç»„ä»¶

å‡½æ•°ç»„ä»¶æœ‰ä¸¤ä¸ªåœ°æ–¹ä¸åŒï¼š

- å‡½æ•°ç»„ä»¶çš„fiberæ²¡æœ‰domèŠ‚ç‚¹
- æ‰§è¡Œä¸€ä¸‹å‡½æ•°ç»„ä»¶ï¼Œæ‰æœ‰children

### åˆ¤æ–­æ˜¯å¦æ˜¯å‡½æ•°ç»„ä»¶

æ‰€ä»¥åœ¨ `performUnitOfWork` æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è¦å…ˆæ£€æµ‹ç»„ä»¶æ˜¯å¦æ˜¯å‡½æ•°ç»„ä»¶ï¼Œç„¶åå°†åˆ†åˆ«å¤„ç†çš„é€»è¾‘æå–åˆ°ä¸¤ä¸ªå‡½æ•° `updateHostComponent` å’Œ `updateFunctionComponent` å†…ï¼š

```diff
function performUnitOfWork(fiber) {
-  if (!fiber.dom) {
-    fiber.dom = createDom(fiber)
-  }

-  const elements = fiber.props.children
-  reconcileChildren(fiber, elements)
  
+  const isFunctionComponent =
+    fiber.type instanceof Function
+  if (isFunctionComponent) {
+    updateFunctionComponent(fiber)
+  } else {
+    updateHostComponent(fiber)
+  }

  if (fiber.child) {
    return fiber.child
  }
  let nextFiber = fiber
  while (nextFiber) {
    if (nextFiber.sibling) {
      return nextFiber.sibling
    }
    nextFiber = nextFiber.parent
  }
}

// å¤„ç†æ™®é€šç»„ä»¶
+ function updateHostComponent(fiber) {
+   if (!fiber.dom) {
+     fiber.dom = createDom(fiber)
+   }
+   reconcileChildren(fiber, fiber.props.children)
+ }

// å¤„ç†å‡½æ•°ç»„ä»¶
+ function updateFunctionComponent(fiber) {
+   // æ‰§è¡Œå‡½æ•°ç»„ä»¶ï¼Œè¿”å› jsx
+   const children = [fiber.type(fiber.props)]
+   reconcileChildren(fiber, children)
+ }
```

### å¤„ç†å‡½æ•°ç»„ä»¶æ²¡æœ‰domçš„é—®é¢˜

å› ä¸ºå‡½æ•°ç»„ä»¶ä¼šå‡ºç°æ²¡æœ‰domçš„æƒ…å†µï¼Œé‚£ `commitWork` æ–¹æ³•çš„é€»è¾‘å°±è¦ä¿®æ­£ä¸€ä¸‹ï¼Œé€šè¿‡`é€’å½’`å¾€ä¸Šå»æ‰¾æœ‰domçš„çˆ¶å…ƒç´ 

```diff
// é€’å½’æ’å…¥æ‰€æœ‰ dom
function commitWork(fiber) {
  if (!fiber) return

-  const domParent = fiber.parent.dom
+  let domParentFiber = fiber.parent
+  while (!domParentFiber.dom) {
+    domParentFiber = domParentFiber.parent
+  }
+  const domParent = domParentFiber.dom

  if ( fiber.effectTag === "PLACEMENT" && fiber.dom != null) {
    // æ’å…¥æ–° dom
    domParent.appendChild(fiber.dom)
    
  // ...
  
   } else if (fiber.effectTag === "DELETION") {
    // åˆ é™¤ dom
    domParent.removeChild(fiber.dom)
  }
  commitWork(fiber.child)
  commitWork(fiber.sibling)
 }
 
+ // å‡½æ•°ç»„ä»¶æ²¡æœ‰ domï¼Œéœ€è¦ä¸€ç›´å¾€ä¸Šé€’å½’æ‰¾çˆ¶ dom
+ function commitDeletion(fiber, domParent) {
+  if (fiber.dom) {
+    domParent.removeChild(fiber.dom)
+  } else {
+    commitDeletion(fiber.child, domParent)
+  }
}
 ```

## hooks

æˆªæ­¢ç›®å‰ï¼Œæˆ‘ä»¬è¿˜ä¸æ”¯æŒ `hooks`ï¼Œæˆ‘ä»¬æ›¿æ¢ä¸€ä¸ªæœ‰ hooks çš„ demo æ¥æ”¯æŒä¸€ä¸‹ï¼š

```diff
- function App(props) {
-   return <h1>Hi {props.name}</h1>
- }
- const profile = <App name="foo" />

+ function Counter() {
+   const [state, setState] = Didact.useState(1)
+   return (
+     <div>
+       <button onClick={() => setState(c => c + 1)}>
+         ç‚¹å‡» + 1
+       </button>
+       <p>Count: {state}</p>
+     </div>
+   )
+ }
+ const profile = <Counter />

const container = document.getElementById("root")
Didact.render(profile, container)
```

### fiber æ–°å¢ hooks å±æ€§

ä¿å­˜å½“å‰è¢«è®¾ç½® `hooks` çš„ `fiber`ï¼Œå› ä¸º `useState` å¯ä»¥è°ƒç”¨å¤šæ¬¡ï¼Œæ‰€ä»¥éœ€è¦ç»´æŠ¤ä¸€ä¸ª `hooks` é˜Ÿåˆ—ï¼Œç”¨æ¥å­˜æ”¾å¤šä¸ª`hook`ï¼Œä¿®æ”¹ `updateFunctionComponent`æ–¹æ³•ï¼š

```diff
+ let wipFiber = null
+ let hookIndex = null

function updateFunctionComponent(fiber) {
+   wipFiber = fiber
+   hookIndex = 0
+   wipFiber.hooks = []
    // æ‰§è¡Œå‡½æ•°ç»„ä»¶ï¼Œè¿”å›jsx
    const children = [fiber.type(fiber.props)]
    reconcileChildren(fiber, children)
}
```

### å®ç° useState

```js
function useState(initial) {
  const oldFiber = wipFiber.alternate;
  const oldHook = oldFiber?.hooks && oldFiber.hooks[hookIndex];
  // è®¾ç½®æ–° hook
  const hook = {
    state: oldHook ? oldHook.state : initial,
    queue: [],
  }

  // æ‰§è¡Œè€ hook é˜Ÿåˆ—é‡Œçš„ setState æ–¹æ³•
  const actions = oldHook ? oldHook.queue : []
  actions.forEach(action => {
    hook.state = action(hook.state)
  })

  const setState = action => {
    hook.queue.push(action)
    // è®¾ç½® nextUnitOfWorkï¼Œä»è€Œåœ¨ä¸‹ä¸€æ¬¡é—²æ—¶å¯åŠ¨æ›´æ–°
    wipRoot = {
      dom: currentRoot.dom,
      props: currentRoot.props,
      alternate: currentRoot,
    }
    nextUnitOfWork = wipRoot
    deletions = []
  }

  wipFiber.hooks.push(hook)
  hookIndex++
  return [hook.state, setState]
}
```
- å› ä¸ºæ˜¯é€šè¿‡å½“å‰ `index` å»æ‰¾ `è€hooks` æ•°ç»„é‡Œå¯¹åº”çš„ `hook`ï¼Œ`æ–°è€hooks`æ•°ç»„é‡Œçš„`hook`æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œæ‰€ä»¥åœ¨ react ä¸­ hook ä¸èƒ½æ”¾åœ¨æ¡ä»¶åˆ¤æ–­è¯­å¥å†…ï¼Œè¿™æ · hook åœ¨æ•°ç»„é‡Œçš„ä½ç½®å°±ä¼šæœ‰å˜åŒ–ï¼Œæ–°æ—§çš„ index ä¸èƒ½å¯¹åº”èµ·æ¥
- `useState` é™¤äº†è¦è¿”å›æœ€åè®¡ç®—çš„`state`å’Œå¯¹åº”çš„`setState`æ–¹æ³•ï¼Œè¿˜è¦åœ¨è¿™ä¹‹å‰æ‰§è¡Œä¸Šä¸€æ¬¡`hooks`é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡
- æ¯è°ƒç”¨ä¸€æ¬¡`useState`ï¼Œ`hook`é˜Ÿåˆ—å°±åˆå…¥åˆ—ä¸€ä¸ªä»»åŠ¡
- æ‰§è¡Œ`setState`ï¼Œä¼šèµ‹å€¼`nextUnitOfWork`ï¼Œè¿™æ ·å°±å¯åŠ¨äº†æµè§ˆå™¨é—²æ—¶å¤„ç†çš„å¼€å…³ï¼Œä¸‹ä¸€æ¬¡é—²æ—¶å°±ä¼šæ›´æ–°`diff`
- ä¸ºäº†ç®€å•ï¼Œè¿™é‡Œçš„`setState`åªæ”¯æŒä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œä¸èƒ½ä¼ å…¥ä¸€ä¸ªå€¼ï¼Œä½†è¦æ”¯æŒå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œåˆ¤æ–­ä¸€ä¸‹æ˜¯ä¸ªå€¼å°±è½¬æ¢æˆä¸€ä¸ªè¿”å›è¯¥å€¼çš„å‡½æ•°ï¼Œå³å¯

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å®ç°äº†è‡ªå·±çš„ä¸€ä¸ª reactâ€”â€”`Didact`

[æ•´ä½“æºç ](https://github.com/chao31/Didact/blob/feature/chao31_final/index.js)

